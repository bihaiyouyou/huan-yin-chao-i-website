<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化支付测试</title>
    <style>
        body { background: #1a1a1a; color: white; padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; background: #2d2d2d; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #ff6b35; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #333; border-radius: 5px; }
        .qr-image { max-width: 200px; border: 2px solid #ff6b35; border-radius: 8px; background: white; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>简化支付测试</h1>
    
    <div class="test-section">
        <h3>1. 订单信息</h3>
        <div>订单号: <span id="orderNumber">-</span></div>
        <div>商品名称: <span id="productName">-</span></div>
        <div>价格: <span id="productPrice">-</span></div>
    </div>
    
    <div class="test-section">
        <h3>2. 二维码</h3>
        <div id="qrLoading" style="display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div>正在生成支付二维码...</div>
        </div>
        <img id="qrCodeImage" class="qr-image" style="display: none;" alt="支付二维码">
    </div>
    
    <div class="test-section">
        <h3>3. 测试按钮</h3>
        <button onclick="testOrderInfo()">测试订单信息</button>
        <button onclick="testQRCode()">测试二维码</button>
        <button onclick="refreshPayment()">刷新支付</button>
    </div>
    
    <div class="test-section">
        <h3>4. 调试信息</h3>
        <div id="debugInfo" class="result"></div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let currentOrderId = null;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('简化支付测试页面加载完成');
            initializeTest();
        });
        
        function initializeTest() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            currentOrderId = urlParams.get('orderId');
            const cardName = urlParams.get('cardName');
            const price = urlParams.get('price');
            
            console.log('URL参数:', { currentOrderId, cardName, price });
            
            // 设置订单信息
            if (currentOrderId) {
                document.getElementById('orderNumber').textContent = currentOrderId;
                document.getElementById('productName').textContent = cardName || '虚拟机器人服务卡';
                document.getElementById('productPrice').textContent = `¥${price || '0.00'}`;
                console.log('订单信息已设置');
            }
            
            // 自动测试二维码
            testQRCode();
        }
        
        function testOrderInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <div>订单ID: ${currentOrderId}</div>
                <div>订单号元素: ${document.getElementById('orderNumber') ? '存在' : '不存在'}</div>
                <div>商品名称元素: ${document.getElementById('productName') ? '存在' : '不存在'}</div>
                <div>价格元素: ${document.getElementById('productPrice') ? '存在' : '不存在'}</div>
            `;
        }
        
        async function testQRCode() {
            const debugInfo = document.getElementById('debugInfo');
            const qrLoading = document.getElementById('qrLoading');
            const qrImage = document.getElementById('qrCodeImage');
            
            try {
                debugInfo.innerHTML = '<div>正在测试二维码生成...</div>';
                
                const response = await fetch(config.getApiUrl('/api/payment/create'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: currentOrderId || 37 })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('二维码数据:', data);
                    
                    qrLoading.style.display = 'none';
                    qrImage.src = data.qrCode;
                    qrImage.style.display = 'block';
                    
                    debugInfo.innerHTML = `
                        <div style="color: green;">✅ 二维码生成成功</div>
                        <div>二维码长度: ${data.qrCode.length} 字符</div>
                        <div>二维码元素: ${qrImage ? '存在' : '不存在'}</div>
                    `;
                } else {
                    debugInfo.innerHTML = `<div style="color: red;">❌ 二维码生成失败: ${response.status}</div>`;
                }
            } catch (error) {
                debugInfo.innerHTML = `<div style="color: red;">❌ 错误: ${error.message}</div>`;
            }
        }
        
        function refreshPayment() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = '<div>刷新支付被点击</div>';
            
            const qrLoading = document.getElementById('qrLoading');
            const qrImage = document.getElementById('qrCodeImage');
            
            qrLoading.style.display = 'flex';
            qrImage.style.display = 'none';
            
            setTimeout(() => {
                testQRCode();
            }, 1000);
        }
    </script>
</body>
</html>
